{
  "datasets": [
    {
      "name": "confusion_by_model_ds",
      "displayName": "Confusion Matrix by Model",
      "queryLines": [
        "SELECT \n",
        "CASE WHEN logs.model_name LIKE '%pytorch%' THEN 'PyTorch' WHEN logs.model_name LIKE '%classifier%' AND logs.model_name NOT LIKE '%pytorch%' THEN 'Keras' ELSE logs.model_name END as model_display_name, \n",
        "f.feedback_type, COUNT(*) as count FROM healthcare_catalog_dev.gold.prediction_feedback f \n",
        "INNER JOIN healthcare_catalog_dev.gold.pneumonia_predictions p ON f.prediction_id = p.prediction_id \n",
        "INNER JOIN \n",
        "      (\n",
        "            SELECT request_metadata['model_name'] as model_name, get_json_object(response, '$.predictions[0][0]') as pred_prob, timestamp_ms \n",
        "            FROM healthcare_catalog_dev.gold.pneumonia_classifier_payload WHERE status_code = 200\n",
        "      ) logs \n",
        "ON CAST(p.prediction_probability AS STRING) = CAST(logs.pred_prob AS STRING) AND ABS(unix_timestamp(p.predicted_at) * 1000 - logs.timestamp_ms) < 5000 \n",
        "\n",
        "GROUP BY CASE WHEN logs.model_name LIKE '%pytorch%' THEN 'PyTorch' WHEN logs.model_name LIKE '%classifier%' AND logs.model_name NOT LIKE '%pytorch%' THEN 'Keras' ELSE logs.model_name END, f.feedback_type \n",
        "ORDER BY \n",
        "CASE f.feedback_type WHEN 'true-positive' THEN 1 WHEN 'false-positive' THEN 2 WHEN 'false-negative' THEN 3 WHEN 'true-negative' THEN 4 ELSE 5 END"
      ]
    }
  ],
  "pages": [
    {
      "name": "model_metrics",
      "displayName": "Model Metrics",
      "layout": [
        {
          "widget": {
            "name": "confusion_matrix",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "confusion_by_model_ds",
                  "fields": [
                    {
                      "name": "feedback_type",
                      "expression": "`feedback_type`"
                    },
                    {
                      "name": "count",
                      "expression": "`count`"
                    },
                    {
                      "name": "model_display_name",
                      "expression": "`model_display_name`"
                    }
                  ],
                  "disaggregated": false
                }
              }
            ],
            "spec": {
              "version": 3,
              "widgetType": "bar",
              "encodings": {
                "x": {
                  "fieldName": "feedback_type",
                  "scale": {
                    "type": "categorical"
                  },
                  "displayName": "Feedback Type"
                },
                "y": {
                  "fieldName": "count",
                  "scale": {
                    "type": "quantitative"
                  },
                  "displayName": "Count"
                },
                "color": {
                  "fieldName": "model_display_name",
                  "scale": {
                    "type": "categorical"
                  },
                  "displayName": "Model"
                }
              },
              "frame": {
                "showTitle": true,
                "title": "Confusion Matrix by Model"
              }
            }
          },
          "position": {
            "x": 0,
            "y": 0,
            "width": 12,
            "height": 6
          }
        }
      ],
      "pageType": "PAGE_TYPE_CANVAS"
    }
  ]
}
